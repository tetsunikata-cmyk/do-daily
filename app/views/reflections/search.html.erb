<div class="page">
  <div class="page-header">振り返り検索</div>

  <!-- ▼ 検索UI（最初はこれだけ見せる） -->
  <div class="black-card">
    <h2>日付を選択</h2>

    <%= form_with url: reviews_search_path, method: :get, local: true do %>
      <%= date_field_tag :date, params[:date], class: "date-input" %>
      <%= submit_tag "検索", name: nil %>
    <% end %>

    <%= form_with url: reviews_search_path, method: :get, local: true do %>
      <%= text_field_tag :q, @q, placeholder: "キーワード検索", class: "search-input" %>
      <%= submit_tag "検索する" %>
    <% end %>
  </div>

  <!-- ▼ 検索結果（検索した時だけ出す） -->
  <% if @searched %>
    <div class="black-card">
      <h2>検索結果</h2>

      <% if @results.any? %>
        <% @results.each do |r| %>
          <div style="padding: 18px 0; border-top: 1px solid rgba(255,255,255,0.2);">
            <h2 style="text-align:center;"><%= r.review_on.strftime("%Y-%m-%d") %></h2>

            <p><strong>今日の課題：</strong><%= r.challenge.to_s %></p>
            <p><strong>振り返り①：</strong><%= r.reflection1.to_s %></p>
            <p><strong>振り返り②：</strong><%= r.reflection2.to_s %></p>
            <p><strong>今日の振り返り：</strong><%= r.summary.to_s %></p>
          </div>
        <% end %>
      <% else %>
        <p>該当する振り返りはありません。</p>
      <% end %>
    </div>
  <% end %>

  <!-- ▼ グラフ（検索ページだけ） -->
  <div class="black-card">
    <h2>直近7日の実行率</h2>
    <% @completion_stats.each do |s| %>
      <div class="completion-row">
        <span><%= s[:date].strftime("%m/%d") %></span>
        <div class="completion-bar-outer">
          <div class="completion-bar-inner" style="width: <%= s[:rate] %>%;">
            <span class="completion-label"><%= s[:rate] %>%</span>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- ▼ 下ナビ（指定どおり3つ＋必要なら「振り返りの記入」も置ける） -->
  <nav class="nav-grid">
    <%= link_to "道しるべを見る", roadmap_path, class: "nav-button" %>
    <%= link_to "My page", mypage_path, class: "nav-button" %>
    <%= link_to "ログアウト", destroy_user_session_path,
                data: { turbo_method: :delete, turbo_confirm: "ログアウトしますか？" },
                class: "nav-button" %>

    <%= render "shared/bottom_nav" %>
  </nav>
</div>