<h1>My Page</h1>

<h2>Goal</h2>

<h2>実現したい写真</h2>

<% if @user.goal_image.attached? %>
  <div style="margin-bottom: 16px;">
    <%= image_tag @user.goal_image, style: "max-width: 100%; height: auto;" %>
  </div>
<% else %>
  <p>まだ画像が登録されていません。</p>
<% end %>

<h3>画像を編集</h3>
<%= form_with model: @user, url: mypage_path,
              method: :patch, local: true, html: { multipart: true } do |f| %>
  <div>
    <%= f.file_field :goal_image %>
  </div>
  <div style="margin-top: 8px;">
    <%= f.submit "更新する" %>
  </div>
<% end %>
<%# 目標が未設定ならプレースホルダを表示 %>
<p>
  <strong>Goal title:</strong>
  <%= current_user.goal_title.presence || "Not set yet" %><br>
  <strong>Goal reason:</strong><br>
  <%= simple_format(current_user.goal_reason.presence || "Not set yet") %>
</p>

<h3>Edit Goal</h3>
<%= form_with model: current_user, url: mypage_path,
              method: :patch, local: true, html: { multipart: true } do |f| %>
  <div>
    <%= f.label :goal_title, "Goal title" %><br>
    <%= f.text_field :goal_title %>
  </div>

  <div>
    <%= f.label :goal_reason, "Why do you want it?" %><br>
    <%= f.text_area :goal_reason, rows: 4 %>
  </div>

  <div>
    <%= f.submit "Update goal" %>
  </div>
<% end %>

<hr>

<h2>Stats</h2>
<ul>
  <li>Total habits: <%= @total_habits %></li>
  <li>Total done logs: <%= @total_logs %></li>
  <li>Done today: <%= @today_done_count %></li>
  <li>Longest current streak: <%= @longest_streak_value %> days</li>
</ul>

<p style="margin-top: 16px;">
  <%= link_to "目標実現ページへ", goal_path,
              style: "display:inline-block; background:#000; color:#fff; padding:12px 24px; text-decoration:none;" %>
</p>

<hr>

<h2>Progress (last 7 days)</h2>

<canvas id="habitsChart" width="400" height="200"></canvas>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("turbo:load", function() {
    const canvas = document.getElementById('habitsChart');
    if (!canvas) return; // 念のため

    const ctx = canvas.getContext('2d');

    const labels = <%= raw @chart_labels.to_json %>;
    const data   = <%= raw @chart_data.to_json %>;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Completed habits per day',
          data: data
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  });
</script>

<hr>

<h2>Your Habits</h2>
<ul>
  <% @habits.each do |habit| %>
    <li>
      <strong><%= habit.title %></strong>
      - Current streak: <%= habit.current_streak %> days
    </li>
  <% end %>
</ul>

<p><%= link_to "Back to DO DAILY.", root_path %></p>