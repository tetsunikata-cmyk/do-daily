<h1>My Page</h1>

<h2>Goal</h2>

<%# 目標が未設定ならプレースホルダを表示 %>
<p>
  <strong>Goal title:</strong>
  <%= current_user.goal_title.presence || "Not set yet" %><br>
  <strong>Goal reason:</strong><br>
  <%= simple_format(current_user.goal_reason.presence || "Not set yet") %>
</p>

<h3>Edit Goal</h3>
<%= form_with model: current_user, url: mypage_path, method: :patch, local: true do |f| %>
  <div>
    <%= f.label :goal_title, "Goal title" %><br>
    <%= f.text_field :goal_title %>
  </div>

  <div>
    <%= f.label :goal_reason, "Why do you want it?" %><br>
    <%= f.text_area :goal_reason, rows: 4 %>
  </div>

  <div>
    <%= f.submit "Update goal" %>
  </div>
<% end %>

<hr>

<h2>Stats</h2>
<ul>
  <li>Total habits: <%= @total_habits %></li>
  <li>Total done logs: <%= @total_logs %></li>
  <li>Done today: <%= @today_done_count %></li>
  <li>Longest current streak: <%= @longest_streak_value %> days</li>
</ul>

<hr>

<h2>Progress (last 7 days)</h2>

<canvas id="habitsChart" width="400" height="200"></canvas>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("turbo:load", function() {
    const canvas = document.getElementById('habitsChart');
    if (!canvas) return; // 念のため

    const ctx = canvas.getContext('2d');

    const labels = <%= raw @chart_labels.to_json %>;
    const data   = <%= raw @chart_data.to_json %>;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Completed habits per day',
          data: data
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  });
</script>

<hr>

<h2>Your Habits</h2>
<ul>
  <% @habits.each do |habit| %>
    <li>
      <strong><%= habit.title %></strong>
      - Current streak: <%= habit.current_streak %> days
    </li>
  <% end %>
</ul>

<p><%= link_to "Back to DO DAILY.", root_path %></p>