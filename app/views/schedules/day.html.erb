<div class="page">
  <div class="page-header">My Schedule</div>

  <div class="black-card">
    <div class="schedule-top">
      <div class="schedule-switch">
        <%= link_to "月",
          habit_schedule_path(@habit, date: @selected_date),
          class: "seg-btn #{'is-active' if @view == :month}" %>

        <%= link_to "週",
          habit_schedule_week_path(@habit, date: @selected_date),
          class: "seg-btn #{'is-active' if @view == :week}" %>

        <%= link_to "日",
          habit_schedule_day_path(@habit, date: @selected_date),
          class: "seg-btn #{'is-active' if @view == :day}" %>
      </div>

      <div class="schedule-nav">
        <%= link_to "←",
          habit_schedule_day_path(@habit, date: (@selected_date - 1.day)),
          class: "nav-arrow" %>

        <div class="nav-title"><%= @selected_date.strftime("%Y/%-m/%-d") %></div>

        <%= link_to "→",
          habit_schedule_day_path(@habit, date: (@selected_date + 1.day)),
          class: "nav-arrow" %>
      </div>
    </div>

    <div class="day-form">
      <%= form_with model: @new_event, url: habit_schedule_events_path(@habit), local: true do |f| %>
        <div class="form-row">
          <%= f.text_field :title, placeholder: "予定タイトル", class: "form-input" %>
          <%= f.text_field :location, placeholder: "場所", class: "form-input" %>
        </div>

        <div class="form-row">
          <%= f.datetime_local_field :starts_at, class: "form-input" %>
          <%= f.datetime_local_field :ends_at, class: "form-input" %>
        </div>

        <div class="form-actions">
          <%= f.submit "追加", class: "habits-btn habits-btn--primary" %>
        </div>
      <% end %>
    </div>

    <div class="day-list">
      <% @events.each do |e| %>
        <div class="day-item">
          <div class="day-time">
            <%= e.starts_at.strftime("%H:%M") %>
            <% if e.ends_at.present? %>〜<%= e.ends_at.strftime("%H:%M") %><% end %>
          </div>

          <div class="day-main">
            <div class="day-title"><%= e.title %></div>
            <div class="day-loc"><%= e.location %></div>
          </div>

          <div class="day-actions">
            <details class="edit-inline">
              <summary class="habits-btn habits-btn--ghost">Edit</summary>

              <%= form_with model: e, url: habit_schedule_event_path(@habit, e), method: :patch, local: true do |f| %>
                <div class="form-row">
                  <%= f.text_field :title, class: "form-input" %>
                  <%= f.text_field :location, class: "form-input" %>
                </div>
                <div class="form-row">
                  <%= f.datetime_local_field :starts_at, class: "form-input" %>
                  <%= f.datetime_local_field :ends_at, class: "form-input" %>
                </div>
                <div class="form-actions">
                  <%= f.submit "保存", class: "habits-btn habits-btn--primary" %>
                </div>
              <% end %>
            </details>

            <%= link_to "Delete",
              habit_schedule_event_path(@habit, e),
              data: { turbo_method: :delete, turbo_confirm: "削除する？" },
              class: "habits-btn habits-btn--danger" %>
          </div>
        </div>
      <% end %>

      <% if @events.empty? %>
        <div class="week-empty">この日は予定なし</div>
      <% end %>
    </div>
  </div>

  <%= render "shared/bottom_nav" %>
</div>