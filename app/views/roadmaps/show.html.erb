<div class="page">
  <div class="page-header">道しるべを見る</div>

  <!-- ===== 道しるべ（5年分） ===== -->
  <div class="black-card">
    <div class="card-header-row">
      <h2>道しるべ</h2>

      <details class="edit-inline">
        <summary>編集</summary>

        <%= form_with url: roadmap_path, method: :patch, local: true do |f| %>
          <% @roadmap_items.each_with_index do |item, idx| %>
            <div class="roadmap-row">
              <%= select_tag "roadmap[#{idx}][year]",
                             options_for_select(@roadmap_year_options, item[:year]),
                             class: "roadmap-year-select" %>

              <%= text_field_tag "roadmap[#{idx}][title]",
                                 item[:title],
                                 class: "roadmap-title-input",
                                 placeholder: "例：専門スキルの確立" %>
            </div>
          <% end %>

          <div class="roadmap-actions">
            <%= f.submit "保存", class: "habit-edit-submit" %>
          </div>
        <% end %>
      </details>
    </div>

    <!-- 表示用 -->
    <ul class="roadmap-list">
      <% @roadmap_items.each do |item| %>
        <li>
          <span class="roadmap-year"><%= item[:year] %>年</span>
          <span class="roadmap-text"><%= item[:title].presence || "—" %></span>
        </li>
      <% end %>
    </ul>
  </div>

  <!-- ===== 年間スケジュール ===== -->
  <div class="black-card">
    <div class="card-header-row">
      <div class="card-header-left">
        <h2>年間スケジュール</h2>
        <span class="year-label"><%= @schedule_year %>年</span>
      </div>

      <details class="edit-inline">
        <summary>編集</summary>

        <!-- 表示年変更 -->
        <%= form_with url: roadmap_path, method: :get, local: true, class: "schedule-year-form" do %>
          <div style="margin-top: 8px;">
            <label style="font-size: 12px;">表示する年</label><br>
            <%= select_tag :year,
                  options_for_select(@schedule_year_options, @schedule_year),
                  class: "roadmap-year-select" %>
            <%= submit_tag "変更", style: "margin-left: 4px; font-size: 12px;" %>
          </div>
        <% end %>

        <!-- 編集用テーブル -->
        <%= form_with url: roadmap_path, method: :patch, local: true, class: "schedule-edit-form" do |f| %>
          <div class="yearly-table-wrap">
            <table class="yearly-table">
              <thead>
                <tr>
                  <th>月</th>
                  <th>予定</th>
                  <th>目標</th>
                  <th>結果</th>
                </tr>
              </thead>
              <tbody>
                <% (1..12).each do |month| %>
                  <% row = @yearly_schedule[month] || { plan: "", target: "", result: "" } %>
                  <tr>
                    <td class="yearly-month"><%= month %>月</td>
                    <td>
                      <%= text_field_tag "schedule[#{month}][plan]",
                                         row[:plan],
                                         class: "yearly-input",
                                         placeholder: "例：学習計画の実行" %>
                    </td>
                    <td>
                      <%= text_field_tag "schedule[#{month}][target]",
                                         row[:target],
                                         class: "yearly-input",
                                         placeholder: "例：理解度向上" %>
                    </td>
                    <td>
                      <%= text_field_tag "schedule[#{month}][result]",
                                         row[:result],
                                         class: "yearly-input",
                                         placeholder: "例：達成 / 未達成" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <div class="roadmap-actions">
            <%= f.submit "保存", class: "habit-edit-submit" %>
          </div>
        <% end %>
      </details>
    </div>

    <!-- 読み取り専用 -->
    <div class="yearly-table-wrap">
      <table class="yearly-table yearly-table-readonly">
        <thead>
          <tr>
            <th>月</th>
            <th>予定</th>
            <th>目標</th>
            <th>結果</th>
          </tr>
        </thead>
        <tbody>
          <% (1..12).each do |month| %>
            <% row = @yearly_schedule[month] || { plan: "", target: "", result: "" } %>
            <tr>
              <td class="yearly-month"><%= month %>月</td>
              <td><%= row[:plan].presence   || "—" %></td>
              <td><%= row[:target].presence || "—" %></td>
              <td><%= row[:result].presence || "—" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <%= render "shared/bottom_nav" %>
</div>